
# Comprehensive Guide to Prometheus in EKS and General Setup

## **Overview of Prometheus Architecture**
Prometheus is a monitoring and alerting toolkit designed to scrape numeric metrics from targets using a pull-based model. Below is an outline of its main components and functionality:

1. **Prometheus Server**
   - Scrapes metrics from configured targets.
   - Stores data in a time-series database (TSDB).
   - Provides a web UI for querying metrics using PromQL.

2. **Retrieval Worker**
   - A Prometheus component responsible for scraping metrics from targets.

3. **Time-Series Database (TSDB)**
   - Stores numeric data collected from the targets.

4. **Exporters**
   - Agents installed on targets to expose metrics to Prometheus at the `/metrics` endpoint. Examples include Node Exporter and MySQL Exporter.

5. **Service Discovery**
   - Dynamically identifies targets using labels or configurations.

6. **Pushgateway**
   - Used for short-lived jobs that push metrics directly to Prometheus.

7. **Alertmanager**
   - Handles alerts generated by Prometheus and forwards them to external systems like Slack or PagerDuty.

8. **HTTP Web Server**
   - Provides a UI for querying metrics and visualizing data.

---

## **Prometheus Setup on Ubuntu**
### **Installation Steps**
1. **Download Prometheus**
   ```bash
   wget https://github.com/prometheus/prometheus/releases/download/v2.x.x/prometheus-2.x.x.linux-amd64.tar.gz
   tar -xvf prometheus-2.x.x.linux-amd64.tar.gz
   cd prometheus-2.x.x.linux-amd64
   ```

2. **Run Prometheus**
   ```bash
   ./prometheus --config.file=prometheus.yml
   ```
   - By default, Prometheus runs on `localhost:9090`.

3. **Set Up as a Service**
   - Create a systemd service file for Prometheus.
   ```bash
   sudo nano /etc/systemd/system/prometheus.service
   ```
   - Add the following content:
   ```plaintext
   [Unit]
   Description=Prometheus Monitoring System
   After=network.target

   [Service]
   User=prometheus
   ExecStart=/path/to/prometheus --config.file=/path/to/prometheus.yml
   Restart=always

   [Install]
   WantedBy=multi-user.target
   ```
   - Reload systemd and start Prometheus:
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl start prometheus
   sudo systemctl enable prometheus
   ```

4. **Verify Installation**
   - Access the Prometheus UI at `http://<server-ip>:9090`.

### **Configure Targets**
Update `prometheus.yml` to include targets.
```yaml
scrape_configs:
  - job_name: 'node_exporter'
    static_configs:
      - targets: ['<target-ip>:9100']
```

---

## **Prometheus in EKS**

### **Prometheus Operator**
The Prometheus Operator simplifies the deployment and management of Prometheus in Kubernetes.

1. **Install the Prometheus Operator**
   - Use Helm to install the Prometheus Operator:
   ```bash
   helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
   helm install prometheus-operator prometheus-community/kube-prometheus-stack -n monitoring --create-namespace
   ```

2. **CRDs Registered by the Operator**
   - `Prometheus`: Defines Prometheus instances.
   - `Alertmanager`: Defines Alertmanager instances.
   - `ServiceMonitor`: Monitors services.
   - `PodMonitor`: Monitors pods.

### **Authentication and Authorization**
1. **Prometheus Operator Authentication**
   - Operators register CRDs with the Kubernetes API server, using the permissions granted by a ServiceAccount.

2. **Prometheus Server Authentication**
   - Prometheus uses a ServiceAccount to authenticate and query the Kubernetes API.
   - Define RBAC roles to authorize Prometheus to list and read metrics.

   Example Role and Binding:
   ```yaml
   apiVersion: rbac.authorization.k8s.io/v1
   kind: Role
   metadata:
     namespace: monitoring
     name: prometheus-role
   rules:
   - apiGroups: [""]
     resources: ["pods", "nodes", "services"]
     verbs: ["get", "list", "watch"]

   ---

   apiVersion: rbac.authorization.k8s.io/v1
   kind: RoleBinding
   metadata:
     namespace: monitoring
     name: prometheus-rolebinding
   roleRef:
     apiGroup: rbac.authorization.k8s.io
     kind: Role
     name: prometheus-role
   subjects:
   - kind: ServiceAccount
     name: prometheus
     namespace: monitoring
   ```

---

## **Multi-Cluster Monitoring**
To scrape metrics from multiple EKS clusters:

1. **Option 1: Single Prometheus Instance**
   - Deploy Prometheus in one cluster (e.g., EKS1).
   - Install exporters in EKS2 and EKS3.
   - Configure Prometheus in EKS1 to scrape targets from EKS2 and EKS3 by adding their endpoints in the `prometheus.yml`.

2. **Option 2: Federated Setup**
   - Deploy Prometheus in all clusters.
   - Configure Prometheus in EKS1 to federate metrics from Prometheus instances in EKS2 and EKS3.
   - Add the federation configuration:
   ```yaml
   scrape_configs:
     - job_name: 'federation'
       honor_labels: true
       metrics_path: '/federate'
       params:
         match[]:
           - '{job="kubernetes-pods"}'
       static_configs:
         - targets:
           - '<EKS2-prometheus-url>'
           - '<EKS3-prometheus-url>'
   ```

---

## **Common Issues and Troubleshooting**
### **1. Prometheus Server Issues**
- **Not Running:** Check pod logs and resource limits.
- **UI Inaccessible:** Verify service exposure and network policies.

### **2. Scraping Issues**
- **Metrics Not Scraped:** Validate target reachability and `ServiceMonitor` configuration.
- **Incomplete Metrics:** Check exporter logs and configurations.

### **3. Exporter Issues**
- **Exporter Down:** Verify pod status and `/metrics` endpoint.
- **High Cardinality Metrics:** Optimize metrics collection using relabeling.

### **4. Alertmanager Issues**
- **Alerts Not Firing:** Debug alert rules in Prometheus.
- **Notifications Failing:** Check Alertmanager configuration and integration logs.

### **5. RBAC and Permissions Issues**
- **Insufficient Permissions:** Validate RBAC roles and bindings.

---

## **Sequence of Prometheus Deployment**
1. **Install the Prometheus Operator**
   - Deploy the operator to register CRDs with the Kubernetes API server.

2. **Create Service Accounts and RBAC Roles**
   - Grant permissions to Prometheus and its components.

3. **Deploy Prometheus Instance**
   - Define the `Prometheus` resource to deploy the Prometheus server.

4. **Configure Monitoring**
   - Use `ServiceMonitor` and `PodMonitor` to define scraping targets.

5. **Set Up Alertmanager**
   - Define alerting rules and configure external integrations.

6. **Expand for Multi-Cluster**
   - Add exporters or federate metrics for additional clusters.

---

This consolidated guide provides a thorough understanding of Prometheus, its setup, and troubleshooting steps for various components. Let me know if further details or examples are required!

